# Requirements Document

## Introduction

This document outlines requirements for improving a personal finance application
that tracks expenses, payment methods, and credit card reward points. The
application was generated by AI and contains several architectural issues,
inconsistencies, and areas for improvement. The primary focus is on fixing the
reward rules management system and addressing code quality issues.

## Glossary

- **Application**: The personal finance tracking web application built with
  React, TypeScript, and Supabase
- **Reward Rule**: A configuration that defines how credit card reward points
  are calculated based on transaction properties
- **Payment Method**: A credit card or cash payment method used for transactions
- **Transaction**: A financial transaction record including merchant, amount,
  and payment method
- **RuleRepository**: The service class responsible for managing reward rules in
  the database
- **RewardService**: The service class responsible for calculating reward points
  based on rules
- **Supabase**: The backend-as-a-service platform providing database and
  authentication
- **MCC**: Merchant Category Code, a four-digit number used to classify business
  types
- **Card Type ID**: A unique identifier for a payment method used to associate
  reward rules

## Requirements

### Requirement 1

**User Story:** As a user, I want to add and modify reward rules for my credit
cards, so that the application accurately calculates reward points for my
transactions.

#### Acceptance Criteria

1. WHEN a user opens the reward rules manager for a payment method THEN the
   Application SHALL display all existing reward rules associated with that
   payment method's card type ID
2. WHEN a user creates a new reward rule THEN the Application SHALL persist the
   rule to the Supabase reward_rules table with the correct card_type_id
3. WHEN a user edits an existing reward rule THEN the Application SHALL update
   the rule in the Supabase reward_rules table and the changes SHALL persist
   after page refresh
4. WHEN a user deletes a reward rule THEN the Application SHALL remove the rule
   from the Supabase reward_rules table and the deletion SHALL persist after
   page refresh
5. WHEN reward rules are loaded THEN the Application SHALL correctly map between
   database schema and application types
6. WHEN the user is offline or Supabase is unavailable THEN the Application
   SHALL provide clear feedback that reward rules cannot be modified

### Requirement 2

**User Story:** As a user, I want the card type ID generation to be consistent
across the application, so that reward rules are correctly associated with
payment methods.

#### Acceptance Criteria

1. WHEN a payment method is created THEN the Application SHALL generate a
   consistent card type ID based on issuer and name
2. WHEN reward rules are queried THEN the Application SHALL use the same card
   type ID generation logic
3. WHEN a payment method's issuer or name is updated THEN the Application SHALL
   maintain the association with existing reward rules or migrate them
   appropriately
4. THE Application SHALL use a centralized function for card type ID generation
   to ensure consistency

### Requirement 3

**User Story:** As a developer, I want clear separation of concerns between data
access, business logic, and presentation layers, so that the codebase is
maintainable and testable.

#### Acceptance Criteria

1. WHEN implementing data access logic THEN the Application SHALL encapsulate
   all database operations within repository classes
2. WHEN implementing business logic THEN the Application SHALL separate
   calculation logic from data access and UI components
3. WHEN implementing UI components THEN the Application SHALL delegate business
   logic to service classes
4. THE Application SHALL follow consistent patterns for dependency injection and
   service instantiation

### Requirement 4

**User Story:** As a developer, I want type safety between the database schema
and application code, so that runtime errors are prevented.

#### Acceptance Criteria

1. WHEN database records are retrieved THEN the Application SHALL map database
   types to application types correctly
2. WHEN database records are persisted THEN the Application SHALL map
   application types to database types correctly
3. THE Application SHALL use TypeScript interfaces that accurately reflect the
   database schema
4. WHEN type mismatches occur THEN the Application SHALL provide clear error
   messages

### Requirement 5

**User Story:** As a user, I want reward points to be calculated accurately
based on configured rules, so that I can track my actual rewards earnings.

#### Acceptance Criteria

1. WHEN a transaction is created THEN the RewardService SHALL find all
   applicable reward rules for the payment method
2. WHEN multiple rules match a transaction THEN the RewardService SHALL apply
   rules based on priority order
3. WHEN a rule has conditions THEN the RewardService SHALL evaluate all
   conditions before applying the rule
4. WHEN a rule has monthly caps THEN the RewardService SHALL enforce the cap
   across all transactions in the period
5. WHEN calculating points THEN the RewardService SHALL correctly apply base
   multipliers, bonus multipliers, and tiered rewards

### Requirement 6

**User Story:** As a developer, I want consistent error handling throughout the
application, so that users receive helpful feedback when operations fail.

#### Acceptance Criteria

1. WHEN a database operation fails THEN the Application SHALL log the error with
   sufficient context for debugging
2. WHEN a database operation fails THEN the Application SHALL display a
   user-friendly error message
3. WHEN validation fails THEN the Application SHALL provide specific feedback
   about what needs to be corrected
4. THE Application SHALL handle network errors gracefully without crashing

### Requirement 7

**User Story:** As a developer, I want the RuleRepository to be properly
initialized and connected to Supabase, so that reward rules persist correctly.

#### Acceptance Criteria

1. WHEN the Application starts THEN the RuleRepository SHALL be initialized with
   the Supabase client
2. WHEN the RuleRepository is accessed THEN the Application SHALL use a
   singleton instance
3. WHEN the RuleRepository is not initialized THEN the Application SHALL provide
   a clear error message instead of failing silently
4. THE Application SHALL initialize the RuleRepository before any reward
   calculations are attempted
5. WHEN reward rules are created, updated, or deleted THEN the RuleRepository
   SHALL execute the corresponding Supabase database operations
6. WHEN database operations complete THEN the RuleRepository SHALL verify the
   operation succeeded before returning

### Requirement 8

**User Story:** As a user, I want the reward rules editor to provide a clear
interface for configuring all rule properties, so that I can set up complex
reward structures.

#### Acceptance Criteria

1. WHEN editing a reward rule THEN the Application SHALL display fields for all
   configurable properties including name, description, priority, conditions,
   and reward configuration
2. WHEN configuring conditions THEN the Application SHALL support MCC codes,
   merchant names, transaction types, and transaction properties
3. WHEN configuring rewards THEN the Application SHALL support base multipliers,
   bonus multipliers, tiered rewards, and monthly caps
4. WHEN saving a rule THEN the Application SHALL validate all required fields
   before persisting
5. THE Application SHALL provide helpful tooltips and examples for complex
   configuration options

### Requirement 9

**User Story:** As a developer, I want comprehensive test coverage for the
reward calculation logic, so that I can confidently make changes without
breaking functionality.

#### Acceptance Criteria

1. THE Application SHALL include unit tests for the RewardService calculation
   methods
2. THE Application SHALL include unit tests for the RuleRepository data access
   methods
3. THE Application SHALL include integration tests for the complete reward
   calculation flow
4. THE Application SHALL include tests for edge cases such as monthly caps,
   tiered rewards, and multiple matching rules
5. WHEN tests are run THEN the Application SHALL achieve at least 80 percent
   code coverage for reward-related modules

### Requirement 10

**User Story:** As a user, I want the payment methods page to clearly show which
reward rules are active, so that I understand how my points are being
calculated.

#### Acceptance Criteria

1. WHEN viewing a payment method THEN the Application SHALL display a summary of
   all active reward rules
2. WHEN viewing reward rule details THEN the Application SHALL show the rule
   name, description, point multipliers, and any caps or conditions
3. WHEN a reward rule is disabled THEN the Application SHALL visually indicate
   that it is not currently active
4. THE Application SHALL provide a quick way to enable or disable individual
   rules

### Requirement 11

**User Story:** As a developer, I want to identify and fix the storage flow
issues preventing reward rules from persisting, so that users can successfully
manage their reward configurations.

#### Acceptance Criteria

1. WHEN investigating the storage flow THEN the Application SHALL log all
   database operations with their results
2. WHEN a reward rule save operation fails THEN the Application SHALL capture
   and display the specific error from Supabase
3. WHEN the RuleRepository methods are called THEN the Application SHALL verify
   the Supabase client is properly authenticated
4. WHEN reward rules are saved THEN the Application SHALL verify the data format
   matches the database schema exactly
5. THE Application SHALL handle the read-only mode flag correctly and not
   silently skip database operations in production
